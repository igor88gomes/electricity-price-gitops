name: GitOps - Release PROD (by SemVer + digest)

on:
  repository_dispatch:
    types: [release-prod]   # Förväntar sig payload.client_payload.version + .digest
  workflow_dispatch:
    inputs:
      version:
        description: "SemVer tag (e.g. v0.1.0) to release to PROD"
        required: true
        type: string
      digest:
        description: "sha256:<...> to pin in PROD"
        required: true
        type: string

permissions:
  contents: write            # Behövs för att skapa branch/commit/PR
  pull-requests: write

env:
  PROD_VALUES_FILE: environments/prod/values.yaml
  PROD_APP_FILE: argo/app-prod.yaml
  BR_PREFIX: release/prod-v

jobs:
  release-prod:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve version and digest input
        id: meta
        shell: bash
        run: |
          # Hämta version + digest från repository_dispatch eller workflow_dispatch
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            V="${{ github.event.client_payload.version }}"
            D="${{ github.event.client_payload.digest }}"
          else
            V="${{ inputs.version }}"
            D="${{ inputs.digest }}"
          fi

          # Enkel validering av SemVer-taggen (t.ex. v0.1.0)
          if [[ -z "$V" || "$V" != v*.*.* ]]; then
            echo "ERROR: version must look like vX.Y.Z (got '$V')" >&2
            exit 1
          fi

          # Enkel validering av digest-formatet
          if [[ -z "$D" || "$D" != sha256:* ]]; then
            echo "ERROR: digest must be like sha256:<hash> (got '$D')" >&2
            exit 1
          fi

          echo "VERSION=$V" >> "$GITHUB_OUTPUT"
          echo "DIGEST=$D"  >> "$GITHUB_OUTPUT"

      - name: Checkout GitOps repo
        uses: actions/checkout@v4

      - name: Create branch and update PROD values
        shell: bash
        run: |
          set -euo pipefail
          BR="${{ env.BR_PREFIX }}${{ steps.meta.outputs.VERSION }}"

          # Skapa ny release-branch för PROD
          git switch -c "$BR"

          # Uppdatera image.tag och image.digest i PROD values
          sed -i -E \
            -e 's|^([[:space:]]*tag:).*|\1 '"${{ steps.meta.outputs.VERSION }}"'|' \
            -e 's|^([[:space:]]*digest:).*|\1 "'"${{ steps.meta.outputs.DIGEST }}"'"|' \
            "${{ env.PROD_VALUES_FILE }}"

          # Endast values uppdateras och ArgoCD-appen spårar alltid 'main'-branchen
          git add "${{ env.PROD_VALUES_FILE }}"

          git -c user.name="github-actions[bot]" \
              -c user.email="github-actions[bot]@users.noreply.github.com" \
              commit -m "release(gitops): PROD -> ${{ steps.meta.outputs.VERSION }}"

          git push -u origin "$BR"

      - name: Open pull request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Skapa PR mot main för PROD-release
          gh pr create \
            --base main \
            --head "${{ env.BR_PREFIX }}${{ steps.meta.outputs.VERSION }}" \
            --title "release(gitops): PROD -> ${{ steps.meta.outputs.VERSION }}" \
            --body  "Promote PROD to image digest \`${{ steps.meta.outputs.DIGEST }}\`.\n\n- Updated \`${{ env.PROD_VALUES_FILE }}\` with \`tag: ${{ steps.meta.outputs.VERSION }}\` and \`digest: ${{ steps.meta.outputs.DIGEST }}\`."
