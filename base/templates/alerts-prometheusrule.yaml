{{- if .Values.alerts.enabled -}}
{{- $targetNs := required "alerts.targetNamespace must be set when alerts.enabled=true" .Values.alerts.targetNamespace -}}
{{- $env := (.Values.alerts.env | default $targetNs) -}}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "electricity.fullname" . }}-alerts
  namespace: {{ .Values.alerts.namespace }}
  labels:
    release: {{ .Values.alerts.releaseLabel }}
    app.kubernetes.io/name: electricity-price
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  # Applikationslarm (kräver kube-prometheus-stack / Prometheus Operator).
  # Aktiveras endast när alerts.enabled=true.
  groups:
    - name: electricity-price-app
      rules:
        - alert: ElectricityPriceDown
          expr: sum(
                  up{
                    namespace="{{ $targetNs }}",
                    service="{{ include "electricity.fullname" . }}"
                  }
                ) == 0
          for: {{ .Values.alerts.downFor }}
          labels:
            severity: critical
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "electricity-price is DOWN in {{ $targetNs }}"
            description: "No 'up' scrape targets for electricity-price in namespace {{ $targetNs }} for at least {{ .Values.alerts.downFor }}."

        - alert: ElectricityPriceHighErrorRate
          expr: |
            sum(
              rate(
                app_http_requests_total{
                  namespace="{{ $targetNs }}",
                  http_status=~"5.."
                }[5m]
              )
            )
            /
            sum(
              rate(
                app_http_requests_total{
                  namespace="{{ $targetNs }}"
                }[5m]
              )
            ) > {{ .Values.alerts.errorRateThreshold }}
          for: {{ .Values.alerts.errorFor }}
          labels:
            severity: warning
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "High HTTP 5xx error rate in electricity-price ({{ $targetNs}})"
            description: "More than {{ mul 100 (.Values.alerts.errorRateThreshold) }}% of HTTP requests returned 5xx status codes over the last {{ .Values.alerts.errorFor }} in namespace {{ $targetNs }}."

        - alert: ElectricityPriceHighLatencyP95
          expr: |
            histogram_quantile(
              0.95,
              sum by (le) (
                rate(
                  app_request_latency_seconds_bucket{
                    namespace="{{ $targetNs }}"
                  }[5m]
                )
              )
            ) > {{ .Values.alerts.latencyP95Seconds }}
          for: {{ .Values.alerts.latencyFor }}
          labels:
            severity: warning
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "High p95 response time for electricity-price in {{ $targetNs }}"
            description: "95th percentile response time is above {{ .Values.alerts.latencyP95Seconds }} seconds for at least {{ .Values.alerts.latencyFor }} in namespace {{ $targetNs }}."

        - alert: ElectricityPriceUpstreamErrorRateHigh
          expr: |
            sum(
              rate(
                app_upstream_requests_total{
                  namespace="{{ $targetNs }}",
                  result="upstream_error"
                }[5m]
              )
            )
            /
            clamp_min(
              sum(
                rate(
                  app_upstream_requests_total{
                    namespace="{{ $targetNs }}"
                  }[5m]
                )
              ),
              1
            )
            > {{ .Values.alerts.upstreamErrorRateThreshold }}

          for: {{ .Values.alerts.upstreamFor }}
          labels:
            severity: info
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "High upstream error rate in electricity-price ({{ $targetNs }})"
            description: "More than {{ mul 100 (.Values.alerts.upstreamErrorRateThreshold) }}% of upstream requests resulted in 'upstream_error' over the last {{ .Values.alerts.upstreamFor }} in namespace {{ $targetNs }}."

        - alert: ElectricityPriceHighCpuUsage
          expr: |
            sum(
              rate(
                container_cpu_usage_seconds_total{
                  namespace="{{ $targetNs }}",
                  container!="",
                  image!=""
                }[5m]
              )
            ) by (pod)
            > {{ .Values.alerts.cpuCoresThreshold }}
          for: {{ .Values.alerts.cpuFor }}
          labels:
            severity: warning
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "High CPU usage per pod in electricity-price ({{ $targetNs }})"
            description: "CPU usage per pod is above ~{{ .Values.alerts.cpuCoresThreshold }} cores for at least {{ .Values.alerts.cpuFor }} in namespace {{ $targetNs }}."

        - alert: ElectricityPriceHighMemoryUsage
          expr: |
            sum(
              container_memory_usage_bytes{
                namespace="{{ $targetNs }}",
                container!="",
                image!=""
              }
            ) by (pod)
            > {{ mul (.Values.alerts.memoryThresholdMi) 1024 1024 }}
          for: {{ .Values.alerts.memoryFor }}
          labels:
            severity: warning
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "High memory usage per pod in electricity-price ({{ $targetNs }})"
            description: "Memory usage per pod is above ~{{ .Values.alerts.memoryThresholdMi }}Mi for at least {{ .Values.alerts.memoryFor }} in namespace {{ $targetNs }}."

        - alert: ElectricityPriceCrashLooping
          expr: |
            increase(
              kube_pod_container_status_restarts_total{
                namespace="{{ $targetNs }}",
                container="app"
              }[5m]
            ) > 3
          for: {{ .Values.alerts.crashFor }}
          labels:
            severity: critical
            app: electricity-price
            env: "{{ $env }}"
          annotations:
            summary: "Pods in electricity-price are crash-looping in {{ $targetNs }}"
            description: "The 'app' container in namespace {{ $targetNs }} restarted more than 3 times within 5 minutes, indicating a possible CrashLoopBackOff or unstable deployment."
{{- end }}
